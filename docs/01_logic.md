# 01. 핵심 로직 설계

본 문서는 **confound-insight** 프로젝트의 핵심 로직을 정의하고,  
의약품 제품명 입력부터 화합물 분석 결과 반환까지의 전체 처리 흐름을 설명한다.

본 문서는 구현 세부사항보다는 **책임 분리, 데이터 흐름, 처리 순서**에 초점을 둔다.

---

## 1. 로직 설계 목표

본 프로젝트의 핵심 로직은 다음 문제를 해결하는 데 목적이 있다.

- 사용자 입력 **의약품 제품명**과 화학 데이터베이스 간의 **식별자 불일치 문제 해결**
- 제품 단위가 아닌 **주성분(화합물) 단위 분석 파이프라인 구축**
- 외부 API(PubChem) 의존성을 안정적으로 관리할 수 있는 구조 설계
- 실시간 요청(API)과 배치 처리(Airflow)의 역할 분리

---

## 2. 전체 처리 흐름 요약

시스템의 핵심 로직은 아래 6단계로 구성된다.

1. 의약품 제품명 입력
2. 제품명 → 주성분 목록 정규화
3. 주성분 → 화합물 식별자(CID) 조회
4. 화합물 구조·물성 데이터 수집
5. 구조 기반 유사도 분석
6. 분석 결과 저장 및 API 응답 반환

---

## 3. 단계별 핵심 로직 정의

### 3.1 의약품 제품명 입력

- 입력 값은 **의약품 제품명 문자열**이다.
- 제품명은 브랜드명, 용량, 제형 등의 정보가 혼합될 수 있으며,
  화학 데이터베이스에서 직접 인식되지 않는다.

---

### 3.2 제품명 → 주성분 목록 정규화

- 식품의약품안전처 개방 데이터를 기준으로
  제품명에 해당하는 **주성분 목록**을 도출한다.
- 단일 성분 의약품과 복합제 의약품을 모두 지원한다.

**출력**
- 원문 성분명(raw_ingredient_name)
- 표준화된 성분명(standard_name)
- 주성분 여부(is_main_active)

**설계 의도**
- 원문 데이터와 정규화 결과를 함께 보관하여
  추적 가능성과 데이터 재현성을 확보한다.

---

### 3.3 주성분 → 화합물 식별자(CID) 조회

- 정규화된 주성분 영문명을 기준으로 PubChem API를 호출한다.
- PubChem에서 제공하는 **CID(Compound ID)** 를 내부 화합물의 기준 식별자로 사용한다.

**예외 처리**
- CID를 찾지 못한 경우:
  - 화합물 레코드는 생성하되, CID는 NULL 허용
  - 이후 배치 처리 또는 재시도 대상으로 관리

---

### 3.4 화합물 구조·물성 데이터 수집

CID가 확보된 화합물에 대해 PubChem API를 통해 다음 정보를 수집한다.

- Canonical SMILES (화합물 구조 문자열)
- Molecular Formula (분자식)
- Molecular Weight (분자량)
- IUPAC Name 등 기본 물성 정보

**설계 원칙**
- PubChem API 호출은 비동기 처리(Celery)로 수행
- 동일 화합물에 대한 중복 호출을 최소화

---

### 3.5 구조 기반 유사도 분석

- SMILES 문자열을 기반으로 RDKit을 사용해
  분자 지문(Fingerprint)을 생성한다.
- 화합물 간 구조 유사도를 계산하고,
  일정 기준 이상의 결과를 저장한다.

**분석 결과**
- 기준 화합물(target)
- 비교 화합물(similar)
- 유사도 점수(similarity_score)

**설계 의도**
- 유사도 계산 로직은 API 요청과 분리하여 재사용 가능하게 설계
- 계산 결과는 재활용을 위해 DB에 저장

---

### 3.6 결과 저장 및 API 응답

- 분석 결과는 다음 단위로 저장된다.
  - 제품
  - 주성분(화합물)
  - 화합물 구조 정보
  - 화합물 간 유사도 결과

- API 응답은 **화합물 단위 분석 결과 요약**을 반환한다.
- 의료적 판단이나 임상적 의미 해석은 포함하지 않는다.

---

## 4. 실시간 처리와 배치 처리의 분리

### 실시간(API) 처리 대상
- 제품명 정규화
- 기존에 저장된 화합물 정보 조회
- 기존 유사도 결과 조회

### 배치(Airflow) 처리 대상
- 자주 조회되는 주성분의 사전 수집
- PubChem 데이터 스냅샷 갱신
- 구조 유사도 재계산
- 데이터 누락 및 정합성 점검

**설계 원칙**
- API는 빠르고 가볍게
- 비용이 큰 연산은 배치로 분리

---

## 5. 로직 설계의 핵심 특징

- 제품 단위가 아닌 **화합물 단위 중심 설계**
- 외부 데이터 의존성 최소화를 위한 캐싱 전략
- 복합제 의약품을 자연스럽게 처리하는 구조
- 확장 가능한 파이프라인 구조 (추가 분석, 신규 데이터 소스 대응 가능)

---

## 6. 범위 및 한계

- 본 로직은 화합물 구조 및 물성 분석에 한정된다.
- 약효, 안전성, 임상적 판단을 제공하지 않는다.
- 분석 결과는 참고 정보로만 사용된다.

---

## 7. 향후 확장 고려 사항

- 성분 별칭 및 다국어 정규화 로직 고도화
- 구조 유사도 결과 시각화 연계
- 분석 결과 버전 관리 및 변경 이력 추적
- 신규 화학 데이터 소스 연동
